name: Generator

on:
  workflow_dispatch:
    inputs:
      account:
        description: 'Number of Accounts to be generated (default = 0)'
        required: false
        default: '0'
      key:
        description: 'Number of Keys to be generated (default = 1)'
        required: false
        default: '1'
      mail:
        description: 'Choose the mail provider to generate license'
        required: true
        type: choice
        options:
        - 1secmail
        - hi2in
        - 10minutemail
        - guerrillamail
        - developermail
        default: 1secmail  # ИЗМЕНИЛИ ПО УМОЛЧАНИЮ НА 1SECMAIL

jobs:
  GenerateKey:
    runs-on: ubuntu-latest
    steps:
      - name: Generate key
        run: |
          ACCOUNT=${{ github.event.inputs.account }}
          KEY=${{ github.event.inputs.key }}
          MAIL=${{ github.event.inputs.mail }}
          git clone https://github.com/cranberis/ESET-KeyGen.git
          cd ESET-KeyGen
          
          # Установка зависимостей
          python3 -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt
          
          # Установка Chrome и драйвера
          sudo apt-get update
          sudo apt-get install -y wget unzip
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt-get install -y ./google-chrome-stable_current_amd64.deb
          
          # Запускаем генерацию
          if [[ ${KEY} != 0 ]]
          then
            echo "Generating ESET key with ${MAIL}..."
            venv/bin/python main.py --chrome --key --email-api ${MAIL} --skip-webdriver-menu --no-headless
            echo -e "\n## Generated Key:" >> $GITHUB_STEP_SUMMARY
            cat ./*KEYS.txt >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No keys file found"
          fi
          
          if [[ ${ACCOUNT} != 0 ]]
          then
            echo "Generating ESET account with ${MAIL}..."
            venv/bin/python main.py --chrome --account --email-api ${MAIL} --skip-webdriver-menu --no-headless
            echo -e "\n## Generated Account:" >> $GITHUB_STEP_SUMMARY
            cat ./*ACCOUNTS.txt >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No accounts file found"
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: eset-results
          path: |
            ESET-KeyGen/*KEYS.txt
            ESET-KeyGen/*ACCOUNTS.txt
          retention-days: 1